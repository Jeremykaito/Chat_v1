package Serveur;
import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.IOException;
import java.net.Socket;
import java.util.ArrayList;

/**
 * ClientThread : thread client traitant la communication serveur/client
 * @author Jérémy Ha, Annelyse Nugue
 * @date 13/11/2016
 */
public class ClientThread implements Runnable{

	//Variables de communication
	private Socket communication;
	private DataInputStream reception;
	private DataOutputStream emission;
	
	//Variables diverses
	private final ArrayList<ClientThread> threads; //La liste des threads clients
	private Chat chat;
	private String nom;
	private String topic;
	private String choix;

	/**
	 * @brief Constructeur
	 * @param Socket com : la socket
	 * @param Chat chat : le chat dans lequel les utilisateurs discutent
	 * @param ArrayList<ClientThread> threads : la liste de threads clients
	 */
	public ClientThread(Socket com, Chat chat, ArrayList<ClientThread> threads){
		this.communication=com;
		this.chat=chat;
		this.threads=threads;
		this.nom="";
		this.topic="";
	}

	/**
	 * @brief Traite les différentes commandes
	 */
	@Override
	public synchronized void run() {

		ArrayList<ClientThread> threads = this.threads;

		try{
			//Création des flux
			reception = new DataInputStream(communication.getInputStream());
			emission = new DataOutputStream(communication.getOutputStream());

			do{
				//Affichage du  menu
				emission.writeUTF("---------------------");
				emission.writeUTF("Bienvenue");
				emission.writeUTF("1 - Se connecter");
				emission.writeUTF("2 - S'inscrire ");
				emission.writeUTF("3 - Quitter ");
				emission.writeUTF("---------------------");
				emission.writeUTF("Que voulez-vous faire (1 à 3) ?");

				//Lecture du choix de l'utilisateur
				choix = reception.readUTF();
				
				switch(choix) {
				
				//Se connecter
				case "1":
					vue_connexion();
					break;
				
				//S'incrire
				case "2":
					vue_inscription();
					break;
					
				//Quitter l'application
				case "3":
					emission.writeUTF("Au revoir !");
					emission.writeUTF("/quit");
					
					//On ferme la socket et les flux
					emission.close();
					reception.close();
					communication.close();
					
					//On sauvegarde le chat
					chat.sauvegarderChat();
					
				default :
					emission.writeUTF("Commande incorrecte...");
					break;
				}
			}while(true);
		}catch(Exception e){
			e.printStackTrace();
		}
	}

	/**
	 * @brief Affichage du menu de connexion
	 */
	public synchronized void vue_connexion() throws IOException {
		
		//Données utilisateur
		String pseudo;
		String mdp;
		boolean connected=false;
		
		//Saisie des données par l'utilisateur
		emission.writeUTF("Veuillez entrer votre pseudo :");
		pseudo = reception.readUTF();
		emission.writeUTF("Veuillez entrer votre mot de passe :");
		mdp = reception.readUTF();
		
		//Pour empêcher la connexion si l'utilisateur est déjà connecté
		for (ClientThread clientThread : threads) {
			if (clientThread.nom.equals(pseudo))
				connected=true;
		}
		
		//Si les données correspondent, l'utilisateur est connecté
		if(chat.connexion(pseudo,mdp) && connected==false){
			nom = pseudo;
			//Accès au chat
			vue_chat();
		}
		else emission.writeUTF("Identification incorrecte!");
	}

	/**
	 * @brief Affichage du menu d'inscription
	 */
	private synchronized void vue_inscription() throws IOException {

		//Données utilisateur
		String pseudo;
		String mdp, mdp_confirm;

		//Saisie des données par l'utilisateur
		emission.writeUTF("Veuillez entrer un nom :");
		pseudo = reception.readUTF();
		emission.writeUTF("Veuillez entrer un mot de passe :");
		mdp = reception.readUTF();	
		emission.writeUTF("Veuillez entrer une nouvelle fois votre mot de passe :");
		mdp_confirm = reception.readUTF();

		//Vérification de la confirmation du mot de passe
		if(mdp.equals(mdp_confirm)) {

			//Vérification de la réponse serveur reçue
			if(chat.creationUtilisateur(pseudo,mdp)) {
				emission.writeUTF("Création réussie !");
			}
			else emission.writeUTF("Désolé ce nom est déjà pris !");
		}
		else emission.writeUTF("Erreur mot de passe non validé");	
	}


	/**
	 * @brief Affichage du menu du chat
	 */
	public void  vue_chat() throws IOException{

		boolean ouvert = true;
		emission.writeUTF("\n- Bonjour "+ nom+" -");
		
		while(ouvert){
			//Affichage informations
			emission.writeUTF("\nNombre de topics existants : " + chat.getNbTopics());
			emission.writeUTF("\nNombre de personnes connectées : " + threads.size());

			//Menu
			emission.writeUTF("---------------------");
			emission.writeUTF("1 - Rejoindre un topic");
			emission.writeUTF("2 - Créer un topic");
			emission.writeUTF("3 - Déconnexion");
			emission.writeUTF("---------------------");
			emission.writeUTF("Que voulez-vous faire ? (1 - 3)");

			//Interprétation de la commande
			choix = reception.readUTF();
			switch(choix) {

			case "1":
				vue_rejoindreTopic();
				break;

			case "2":
				vue_creationTopic();
				break;

			case "3":
				emission.writeUTF("Déconnexion...");
				nom="";
				ouvert = false;
				break;

			default :
				emission.writeUTF("Commande incorrecte...");
				break;
			}

		}
	}

	/**
	 * @brief Affichage du menu pour rejoindre un topic
	 */
	private synchronized void vue_rejoindreTopic() throws IOException {

		//Données utilisateur
		String titre;

		//Affichage des topics existants 
		emission.writeUTF("\nTopics existants : \n");
		for(Topic topic : chat.getTopics()) {
			int nb_connecte=0;
			for(ClientThread t : threads){
				if(t.topic.equals(topic.getTitre()))
					nb_connecte++;
			}
			emission.writeUTF(topic.toString()+" - (Personnes connectées : "+nb_connecte+")");
			}
		
		//Saisie des données par l'utilisateur
		emission.writeUTF("\nVeuillez entrer le titre :");
		titre = reception.readUTF();

		//Si le topic existe, l'utilisateur le rejoint
		if(chat.existTopic(titre)) {
			topic = titre;
			vue_topic(topic);
		}
		else emission.writeUTF("Désolé aucun topic correspondant.");
	}

	/**
	 * @brief Affichage du menu de création d'un topic
	 */
	private synchronized void vue_creationTopic() throws IOException {

		//Données utilisateur
		String titre;
		String description;

		//Saisie des données par l'utilisateur
		emission.writeUTF("Veuillez entrer un titre :");
		titre = reception.readUTF();
		emission.writeUTF("Veuillez entrer une description :");
		description = reception.readUTF();

		//Création du topic
		if(chat.creationTopic(titre,description)) {
			emission.writeUTF("Création réussie !");
		}
		else emission.writeUTF("Désolé ce titre est déjà pris !");
	}

	/**
	 * @brief Affichage de l'interface permettant de communiquer dans le topic
	 */
	private synchronized void vue_topic(String topic) throws IOException{

		boolean ouvert =true;

		//Message de bienvenue
		emission.writeUTF("\nBienvenue dans le topic " + topic + "\n");
		emission.writeUTF("----------------------------------------------------------");
		emission.writeUTF("Commandes : ");
		emission.writeUTF("/exit pour quitter ce topic");
		emission.writeUTF("----------------------------------------------------------\n");
		
		emission.writeUTF(chat.getTopicMessages(topic));

		do{

			//On récupère le texte tapé par l'utilisateur
			String msg = reception.readUTF();

			//Si le message est /exit, on quitte le topic
			if(msg.equalsIgnoreCase("/exit")){
				ouvert=false;
				topic = "";
			}
			
			//Sinon, on envoie le message aux utilisateurs du même topic
			else{ 
				chat.addMessage(topic,msg,nom);
				for (ClientThread clientThread : threads) {
					if (clientThread.topic.equals(this.topic) && !clientThread.nom.equals(this.nom)) {
						clientThread.emission.writeUTF(nom + " : " + msg);
					}
				}
			}
		}while (ouvert);
	}
}
